---

# ---- Install and configure Varnish server ----

- include: upstream.yml
  when: (
          varnish_upstream|d() or not (
            varnish_upstream_version == '4.0' and ansible_distribution == 'Debian'
              and ansible_distribution_release in ['jessie']
          )
        )

- name: Install required packages
  apt:
    name: 'varnish'
    state: 'present'
    install_recommends: False

- name: Configure Varnish
  template:
    src: 'etc/default/varnish.j2'
    dest: '/etc/default/varnish'
    owner: 'root'
    group: 'root'
    mode: '0644'
  notify: [ 'Restart varnish' ]

- name: Configure default.vcl for Varnish
  template:
    src: 'etc/varnish/default.vcl.j2'
    dest: '/etc/varnish/default.vcl'
    owner: 'root'
    group: 'root'
    mode: '0644'
  notify: [ 'Restart varnish' ]
